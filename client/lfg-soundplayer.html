<script src="soundjs.min.js"></script>

<script>
(function () {
	window.lfgSound = {
		/**
		 * Create a new instance of a sound.
		 * @param {string} soundname - The name of the soundfile to play.
		 */
		play: function (soundname) {
			// Create an instance of the sound, which begins playing immediately.
			var instance = createjs.Sound.play(soundname);

			// Set the volume
			soundsRep.value.some(function (sound) {
				if (sound.name === soundname) {
					instance.volume = sound.volume / 100;
					instance.pan = 0.0001;
					return true;
				}
			});

			return instance;
		},

		/**
		 * Stops all currently playing sounds.
		 */
		stop: function () {
			createjs.Sound.stop();
		}
	};

	var soundsRep = NodeCG.Replicant('sounds', 'lfg-sounds')
			.on('change', function (oldVal, newVal) {
				registerSounds(newVal);
			});

	// When any of the sound files change, remove and re-register all sounds.
	// This will stop any currently playing sounds.
	window.lfgSound.ready = false;
	NodeCG.Replicant('files', 'lfg-sounds')
			.on('change', function () {
				createjs.Sound.removeAllSounds();
				registerSounds(soundsRep.value);

				if (!window.lfgSound.ready) {
					window.lfgSound.ready = true;
					document.dispatchEvent(new CustomEvent('lfgSoundsReady'));
				}
			});

	function registerSounds(sounds) {
		var manifest = [];
		sounds.forEach(function (sound) {
			if (sound.file) {
				manifest.push({
					id: sound.name,
					src: sound.file,
					data: {channels: 100}
				})
			}
		});

		createjs.Sound.registerSounds({
			path: '/lfg-sounds/',
			manifest: manifest
		});
	}
})();
</script>
