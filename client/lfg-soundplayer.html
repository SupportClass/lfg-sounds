<script src="/graphics/lfg-sounds/components/SoundJS/lib/soundjs-0.6.1.min.js"></script>

<script>
(function() {
    window.lfgSound = {
        /**
         * Creates a new NodeCG extension API instance.
         * @param {string} soundname    The name of the soundfile to play.
         */
        play: function (soundname) {
            // Create an instance of the sound, which begins playing immediately.
            var instance = createjs.Sound.play(soundname);

            // Set the volume
            soundsRep.value.some(function(sound) {
                if (sound.name === soundname) {
                    instance.volume = sound.volume / 100;
                    return true;
                }
            });

            // Fix panning bugs caused by changes to how Panning works in new versions of Chrome and FF.
            // This will be fixed in the next version of SoundJS, at which point this hack can be removed.
            instance.pan = 0.0001;
        },

        /**
         * Stops all currently playing sounds.
         */
        stop: function () {
            createjs.Sound.stop();
        }
    };

    var soundsRep = NodeCG.Replicant('sounds', 'lfg-sounds')
        .on('change', function(oldVal, newVal) {
            registerSounds(newVal);
        });

    // When any of the sound files change, remove and re-register all sounds.
    // This will stop any currently playing sounds.
    NodeCG.Replicant('files', 'lfg-sounds')
        .on('change', function() {
            createjs.Sound.removeAllSounds();
            registerSounds(soundsRep.value);
        });

    // This currently only works if there is an instance of the API in the window
    if (window.nodecg) {
        nodecg.listenFor('testSound', 'lfg-sounds', function(soundname) {
            window.lfgSound.play(soundname);
        });
    }

    function registerSounds(sounds) {
        var manifest = [];
        sounds.forEach(function(sound) {
            if (sound.file) {
                manifest.push({
                    id: sound.name,
                    src: sound.file
                })
            }
        });

        createjs.Sound.registerSounds({
            path: '/lfg-sounds/',
            manifest: manifest
        });
    }
})();
</script>
