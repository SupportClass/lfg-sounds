<link rel="import" href="../components/polymer/polymer.html">
<link rel="import" href="lfg-soundpanel-sound.html">

<dom-module id="lfg-soundpanel">
	<template></template>
</dom-module>

<script>
(function () {
	// Find first ancestor of el with tagName, or undefined if not found
	function upTo(el, tagName) {
		tagName = tagName.toLowerCase();

		while (el && el.parentNode) {
			el = el.parentNode;
			if (el.tagName && el.tagName.toLowerCase() === tagName) {
				return el;
			}
		}

		return null;
	}

	Polymer({
		is: 'lfg-soundpanel',
		properties: {
			bundle: {
				type: String,
				observer: 'bundleChanged'
			}
		},

		/*
		 * Lifecycle
		 */

		ready: function () {
			var self = this;
			var soundsRep = NodeCG.Replicant('sounds', 'lfg-sounds');
			soundsRep.on('change', function (oldVal, newVal) {
				// If there is an existing <lfg-soundpanel-sound> element for this sound, edit that.
				// Otherwise, make a new one and add it to the DOM.
				newVal.forEach(function (sound) {
					var existingEl = self.$$('lfg-soundpanel-sound[name="' + sound.name + '"]');
					if (existingEl) {
						existingEl.volume = sound.volume;
						existingEl.file = sound.file;
					} else {
						var newEl = document.createElement('lfg-soundpanel-sound');
						newEl.name = sound.name;
						newEl.volume = sound.volume;
						newEl.file = sound.file;
						Polymer.dom(self.root).appendChild(newEl);
					}
				});

				// If there is an element for a sound that no longer exists, remove it.
				Polymer.dom(self.root).querySelectorAll('lfg-soundpanel-sound').forEach(function (el) {
					var foundCorrespondingSound = newVal.some(function (sound) {
						return sound.name === el.name;
					});

					if (!foundCorrespondingSound) {
						Polymer.dom(self.root).removeChild(el);
					}
				});
			});

			this.addEventListener('change', function (e) {
				var soundEl = upTo(e.target, 'lfg-soundpanel-sound');

				// Update the replicant with the new volume and file
				soundsRep.value.some(function (sound, idx) {
					if (sound.name === soundEl.name) {
						soundsRep.value[idx].volume = soundEl.volume;
						soundsRep.value[idx].file = soundEl.file;
						return true;
					}
				});
			})
		}
	});
})();
</script>
